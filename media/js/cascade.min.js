/*
 * @package   pkg_radicalreviews
 * @version   1.0.0
 * @author    Dmitriy Vasyukov - https://fictionlabs.ru
 * @copyright Copyright (c) 2023 Fictionlabs. All rights reserved.
 * @license   GNU/GPL license: http://www.gnu.org/copyleft/gpl.html
 * @link      https://fictionlabs.ru/
 */

"use strict";class RadicalMartFieldsCascade{constructor(e){this.container=e,this.id=this.container.getAttribute("data-id"),this.options=null,this.items=Joomla.getOptions("plg_radicalmart_fields_cascade_"+this.id),this.not_use=Joomla.Text._("JOPTION_DO_NOT_USE")}initialize(){this.initRepeatable(),this.initSelects();let e=this;document.querySelectorAll("select").forEach(((t,i)=>{t.addEventListener("change",(function(i){let l=parseInt(t.getAttribute("data-index")),a=t.value,s=e.getParentValues(l),n=e.container.querySelector('[data-index="'+(l+1)+'"]');n&&(e.fillSelect(n,a,s,!1),n.dispatchEvent(new Event("change")))}))}))}initSelects(){let e=this;this.container.querySelectorAll("select").forEach(((t,i)=>{let l=new RadicalMartFieldSelect(t),a=t.value;l.disable(),e.checkValue(a)||l.enable(),t.querySelectorAll("option").length>1?l.enable():(l.replaceOptions(e.convertOptions({},this.getName(t))),l.disable())}))}initRepeatable(){let e=this;document.addEventListener("subform-row-add",(function(t){let i=t.detail.row,l=i.querySelector('[data-cascade="container"]');l.setAttribute("data-id",e.id),i.querySelectorAll("select").forEach(((t,i)=>{let l=new RadicalMartFieldSelect(t);l.replaceOptions({"":e.text_all}),l.disable(),0===i&&(l.replaceOptions(e.convertOptions(e.items,e.getName(t))),l.enable())})),new RadicalMartFieldsCascade(l).initialize()}))}getParentValues(e){let t={};for(var i=0;i<=e;i++)t[i]=this.container.querySelector('[data-index="'+i+'"]').value;return t}fillSelect(e,t,i,l){let a=this.items,s=new RadicalMartFieldSelect(e);if(!l)for(const[e,t]of Object.entries(i))a=void 0!==a[t]?a[t]:{};let n=this.convertOptions(a,this.getName(e));s.replaceOptions(n),e.querySelectorAll("option").length>1?s.enable():s.disable()}checkValue(e){return void 0!==e&&![""," ","0"].includes(e)}convertOptions(e,t=!1){let i={};t&&(i={"":Object.keys(e).length?t:this.not_use}),console.info();for(const[t,l]of Object.entries(e))i[t]=t;return i}getName(e){return"- "+e.getAttribute("data-name")+" -"}setVariable(e,t){this[e]=t}getVariable(e,t=null){return this[e]&&null!==this[e]?this[e]:t}}class RadicalMartFieldSelect{constructor(e){this.select=e}toggle(e){e?(this.select.removeAttribute("disabled"),this.select.closest('[data-cascade="parent"]').style.display=""):(this.select.setAttribute("disabled","disabled"),this.select.closest('[data-cascade="parent"]').style.display="none")}disable(){this.toggle(!1)}enable(){this.toggle(!0)}removeOptions(e=!1,t){e?this.select.querySelectorAll("option:not(:first-child)").forEach(((e,t)=>{e.remove()})):this.select.querySelectorAll("option").length&&this.select.querySelectorAll("option").forEach(((e,t)=>{e.remove()}))}replaceOptions(e){this.removeOptions(),this.newOptions(e)}newOptions(e,t){this.removeOptions(t,!1),this.addOptions(e,!1)}addOptions(e,t){for(const[t,i]of Object.entries(e))this.addOption(t,i)}addOption(e,t){let i=document.createElement("option");i.value=e,i.innerHTML=t,this.select.appendChild(i)}}document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll('[data-cascade="container"]').forEach(((e,t)=>{new RadicalMartFieldsCascade(e).initialize()}))}));